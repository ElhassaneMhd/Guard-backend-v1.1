# **Gemini Code Generation Rules: Lead Management System Backend (Laravel)**

## **1\. Objective**

Your task is to generate the complete backend source code for a Lead Management System using the **Laravel framework (version 11 or higher)**. You must strictly adhere to the architecture, patterns, and security practices defined in this document. The final code must be clean, maintainable, and highly secure.

## **2\. Core Technology Stack**

- **Framework**: **Laravel**
- **Language**: **PHP 8.2+**
- **Database**: **MYSQL**
- **Authentication**: **Laravel Passport**
- **Authorization**: **spatie/laravel-permission**

## **3\. Initial Setup: Roles & Permissions Seeder**

This is the most critical first step. You must create a database seeder named RolesAndPermissionsSeeder.php. This seeder will define all roles and permissions, establishing the foundation for the application's authorization system.

1. **Define Permissions**: Create permissions with granular names. Use a subject.action format.
   - users.create, users.view, users.update, users.delete
   - leads.create, leads.view, leads.assign, leads.accept-decline, leads.update-status
   - organizations.create, organizations.view, organizations.update
   - reports.view
2. **Define Roles**: Create all roles specified in the project requirements.
   - Admin, Group Director, Partner Director, Coordinator, Sales Manager, Sales Agent, Referral
3. **Assign Permissions to Roles**: In the seeder, assign the permissions to the roles according to the project hierarchy.
   - **Admin**: Assign all permissions (\*).
   - **Group Director**: Assign all permissions except the most sensitive admin-only ones.
   - **Partner Director**: users.create (for managers), users.view (their org), organizations.edit (their org), reports.view-organization.
   - **Coordinator**: leads.view (all new), leads.assign.
   - **Sales Manager**: users.create (for agents), leads.view (their team), leads.assign (to their agents), reports.view-team.
   - **Sales Agent**: leads.view (assigned to them), leads.accept-decline, leads.edit-status.
   - **Referral**: leads.view (created by them).

## **4\. Database & Models**

- **Migrations**: Generate standard migration files. All primary keys and foreign key relationships **must** use the uuid type.
- **Traits**:
  - All models **must** use the Illuminate\\Database\\Eloquent\\Concerns\\HasUuids trait.
  - The User model **must** use the Spatie\\Permission\\Traits\\HasRoles trait.
- **Mass Assignment**: All models **must** define the $fillable property to protect against mass assignment vulnerabilities.
- **Relationships**: Explicitly define all Eloquent relationships (belongsTo, hasMany, etc.) in the models.

## **5\. Architecture & Design Pattern Rules**

You must follow a strict Service-Repository-Controller pattern.

1. **Controllers (The "How")**:
   - **MUST** be thin. Their only job is to handle the HTTP request and response cycle.
   - **MUST** use Form Request classes for all input validation.
   - **MUST** call Service classes to execute business logic.
   - **MUST** use API Resources to format all JSON responses.
   - **MUST NOT** contain any business logic or Eloquent queries.
2. **Services (The "What")**:
   - **MUST** contain all business logic (e.g., how to assign a lead, what happens when a lead is accepted).
   - **MUST** be injected into controllers via the constructor.
   - **MUST** interact with Repository interfaces, not directly with Eloquent models.
   - **MUST** dispatch events after a successful operation (e.g., LeadAssigned event).
3. **Repositories (The "Where")**:
   - **MUST** contain all database query logic. Create an interface (e.g., LeadRepositoryInterface) and a concrete implementation (e.g., EloquentLeadRepository).
   - **MUST** be bound to their interfaces in a Service Provider (e.g., RepositoryServiceProvider).
   - **MUST** be injected into Service classes.

## **6\. Authorization Implementation Rules**

1. **Route-Level Authorization**: In routes/api.php, protect routes and route groups using Spatie's middleware based on permissions.
   - Example: Route::post('/users', ...)-\>middleware('can:users.create');
2. **Model-Level Authorization (Policies)**:
   - Generate a Policy for each core model (LeadPolicy, UserPolicy, etc.).
   - Policies are for checking if an action is allowed on a _specific model instance_.
   - The logic inside policies **must** check for ownership and hierarchy.
   - Example LeadPolicy@update: "Does the current user own this lead, OR is the user a manager in the same organization as this lead?"

## **7\. API & Security Rules**

- **Standardized Responses**: All API responses **must** be wrapped using API Resources that produce the standard JSON structure defined in the plan ({ success: true, data: {...} }). Create a base API resource or trait for this.
- **Error Handling**: Use Laravel's exception handler to catch exceptions and format error responses into the standard JSON error structure.
- **Rate Limiting**: Apply the throttle:api middleware to all API routes in routes/api.php.
- **CORS**: Configure config/cors.php to only allow origins from the specified frontend URL.
- **Ingestion Endpoint**: The POST /api/leads/ingest endpoint **must** be protected by a custom ApiKeyAuthMiddleware that validates a secret key from the request headers.
